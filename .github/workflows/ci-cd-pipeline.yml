name: CI/CD Pipeline

on:
  push:
    branches: [ AWS-EC2 ]
  pull_request:
    branches: [ AWS-EC2 ]
  workflow_dispatch:
   
env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/my-portfolio
  REGISTRY: docker.io

jobs:
  # Job 1: Build and Test
  build-and-test:
    name: Build and Test Application
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linter
      run: npm run lint
      continue-on-error: true

    - name: Build application
      run: npm run build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: dist/
        retention-days: 1

  # Job 2: Build and Push Docker Image
  docker-build-push:
    name: Build and Push Docker Image
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/AWS-EC2'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.DOCKER_IMAGE }}
        tags: |
          type=sha,prefix={{branch}}-
          type=raw,value=latest
          type=raw,value={{date 'YYYYMMDD-HHmmss'}}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
        cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max

    - name: Image digest
      run: echo "Image pushed with tags - ${{ steps.meta.outputs.tags }}"

  # Job 3: Deploy to AWS EC2
  deploy-to-aws:
    name: Deploy to AWS EC2
    needs: docker-build-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/AWS-EC2'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install Ansible
      run: |
        python -m pip install --upgrade pip
        pip install ansible boto3 botocore

    - name: Configure SSH
      run: |
        SSH_DIR="$HOME/.ssh"
        mkdir -p "$SSH_DIR"
        echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > "$SSH_DIR/id_rsa"
        chmod 600 "$SSH_DIR/id_rsa"
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> "$SSH_DIR/known_hosts"

    - name: Create Ansible inventory
      run: |
        cat > inventory.ini << EOF
        [webservers]
        ${{ secrets.EC2_HOST }} ansible_user=${{ secrets.EC2_USER }} ansible_ssh_private_key_file=$HOME/.ssh/id_rsa
        EOF

    - name: Run Ansible playbook
      env:
        ANSIBLE_HOST_KEY_CHECKING: 'False'
      run: |
        ansible-playbook -i inventory.ini ansible/deploy.yml \
          -e "docker_image=${{ env.DOCKER_IMAGE }}:latest" \
          -e "dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
          -e "dockerhub_token=${{ secrets. DOCKERHUB_TOKEN }}"

    - name: Deployment status
      run: echo "âœ… Application deployed successfully to AWS EC2!"

  # Job 4: Notify deployment status
  notify:
    name: Notify Deployment Status
    needs: [build-and-test, docker-build-push, deploy-to-aws]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Deployment Summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Status**: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Docker Build**: ${{ needs.docker-build-push.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment**: ${{ needs.deploy-to-aws.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
